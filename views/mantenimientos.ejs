<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Mantenimientos | Inventario & Mantenimientos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    * { transition: background-color 0.25s ease, color 0.25s ease, box-shadow 0.25s ease; }

    :root{ --primary:#0d6efd; --muted:#6c757d; --card-radius:12px; --glass-blur:10px; --light-bg:#f5f7fa; --light-card:#ffffff; --light-text:#212529; --light-muted:#6c757d; }
    html[data-theme="dark"] { --light-bg:#0f3460; --light-card:rgba(22,33,62,0.75); --light-text:#e6eef8; --light-muted:#9fb6d9; }

    body { min-height:100vh; color:var(--light-text); background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.06), transparent 8%), radial-gradient(circle at 90% 80%, rgba(255,255,255,0.04), transparent 12%), linear-gradient(135deg, var(--light-bg) 0%, #c3cfe2 100%); -webkit-font-smoothing:antialiased; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; font-size:0.95rem; }
    html[data-theme="dark"] body{ background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02), transparent 8%), radial-gradient(circle at 90% 80%, rgba(255,255,255,0.01), transparent 12%), linear-gradient(135deg, #0f3460 0%, #16213e 100%); }

    .navbar{ background: linear-gradient(90deg, var(--light-card) 0%, rgba(255,255,255,0.95) 100%) !important; backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border:1px solid rgba(255,255,255,0.22); box-shadow:0 8px 30px rgba(7,12,31,0.06); }
    html[data-theme="dark"] .navbar{ background: linear-gradient(90deg, rgba(22,33,62,0.92), rgba(15,52,96,0.92)) !important; border:1px solid rgba(255,255,255,0.06); }

    .navbar-brand { font-weight:700; font-size:1.15rem; display:flex; gap:.6rem; align-items:center; }
    .navbar-brand img { height:36px; width:auto; }

    main { padding:2.25rem 0; }
    .page-wrapper { max-width:1200px; margin:0 auto; }

    .page-header { border-radius:16px; padding:1.6rem; margin-bottom:1.6rem; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75)); backdrop-filter: blur(var(--glass-blur)); border:1px solid rgba(255,255,255,0.2); box-shadow: 0 12px 36px rgba(7,12,31,0.06); }
    html[data-theme="dark"] .page-header{ background: linear-gradient(135deg, rgba(22,33,62,0.9), rgba(15,52,96,0.85)); border:1px solid rgba(255,255,255,0.06); }

    .page-title { font-weight:700; background:linear-gradient(135deg,var(--primary),#0dcaf0); background-clip: text; -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:0.25rem; font-size:1.05rem; }
    .page-sub { color:var(--light-muted); margin:0; font-size:0.9rem; }

    .table-card { border-radius: 14px; overflow:hidden; background: linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.7)); border:1px solid rgba(255,255,255,0.18); box-shadow: 0 18px 50px rgba(7,12,31,0.06); }
    html[data-theme="dark"] .table-card{ background: linear-gradient(135deg, rgba(22,33,62,0.72), rgba(15,52,96,0.65)); border:1px solid rgba(255,255,255,0.06); box-shadow:0 18px 50px rgba(0,0,0,0.35); }

    .table thead th{ background: linear-gradient(135deg, rgba(13,110,253,0.06), rgba(13,202,240,0.03)); border-bottom:2px solid rgba(13,110,253,0.12); color:var(--light-text); text-transform:uppercase; font-weight:600; font-size:0.78rem; }
    html[data-theme="dark"] .table thead th{ border-bottom:2px solid rgba(255,255,255,0.06); }

    .table tbody tr { transition:background 0.2s ease, transform 0.2s ease; }
    .table tbody tr:hover { background: linear-gradient(135deg, rgba(13,110,253,0.04), rgba(13,202,240,0.02)); transform:translateY(-2px); }

    .btn-compact { padding:0.45rem 0.75rem; font-size:0.85rem; border-radius:8px; font-weight:600; }
    .btn-success { background: linear-gradient(135deg,#198754 0%, #20c997 100%); color:white; border:none; }
    .btn-warning { background: linear-gradient(135deg,#ffc107,#ff9800); color:white; border:none; }
    .btn-danger { background: linear-gradient(135deg,#dc3545,#e74c3c); color:white; border:none; }

    .modal-content{ border-radius:14px; backdrop-filter: blur(var(--glass-blur)); background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95)); border:1px solid rgba(255,255,255,0.3); box-shadow:0 30px 80px rgba(7,12,31,0.12); }
    html[data-theme="dark"] .modal-content{ background: linear-gradient(135deg, rgba(22,33,62,0.95), rgba(15,52,96,0.95)); border:1px solid rgba(255,255,255,0.06); box-shadow:0 30px 80px rgba(0,0,0,0.45); }

    .form-control, .form-select { border-radius:8px; border:1px solid rgba(0,0,0,0.08); background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9)); color:var(--light-text); }
    html[data-theme="dark"] .form-control, html[data-theme="dark"] .form-select { background: linear-gradient(135deg, rgba(22,33,62,0.85), rgba(15,52,96,0.8)); border:1px solid rgba(255,255,255,0.06); }

    .col-acciones { text-align: center; white-space: nowrap; width: 180px; }
    .preview-img { max-height: 100px; border-radius: 8px; display: block; margin-top: 4px; }
    .toast-container { z-index: 1080; }

    @media (max-width:768px){ .page-header { padding:1rem; } .page-title { font-size:1rem; } .table thead th { font-size:0.7rem; } .btn-compact { padding:0.35rem 0.6rem; font-size:0.8rem; } }
  </style>
</head>

<body class="d-flex flex-column min-vh-100">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <img src="/img/logosanrafa.png" alt="HSRT logo" class="rounded">
        <span>HSRT</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNavbar">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/equipos"><i class="fas fa-box me-1"></i>Equipos</a></li>
          <li class="nav-item"><a class="nav-link" href="/ubicaciones"><i class="fas fa-map-pin me-1"></i>Ubicaciones</a></li>
          <li class="nav-item"><a class="nav-link" href="/responsables-custodios"><i class="fas fa-user me-1"></i>Responsables</a></li>
          <li class="nav-item"><a class="nav-link" href="/personas-mantenimiento"><i class="fas fa-users me-1"></i>Personas</a></li>
          <li class="nav-item"><a class="nav-link" href="/cargos"><i class="fas fa-briefcase me-1"></i>Cargos</a></li>
          <li class="nav-item"><a class="nav-link active" href="/mantenimientos"><i class="fas fa-wrench me-1"></i>Mantenimientos</a></li>
          <% if (currentUser && currentUser.role === 'admin') { %>
            <li class="nav-item"><a class="nav-link" href="/usuarios"><i class="fas fa-user-shield me-1"></i>Usuarios</a></li>
          <% } %>
          <li class="nav-item"><a class="nav-link" href="/mi-perfil"><i class="fas fa-user-circle me-1"></i>Mi Perfil</a></li>
        </ul>

        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-theme" id="themeToggle" title="Cambiar tema" style="border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center;">
            <i class="fas fa-moon"></i>
          </button>

          <% if (currentUser) { %>
            <span class="navbar-text me-2 text-muted small">
              <i class="fas fa-user-check me-1"></i>
              <strong><%= currentUser.username %></strong> |
              <strong><%= currentUser.role %></strong>
            </span>
            <form method="post" action="/logout" class="d-inline m-0">
              <button class="btn btn-danger btn-compact"><i class="fas fa-sign-out-alt me-1"></i>Salir</button>
            </form>
          <% } %>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="flex-grow-1">
    <div class="container-fluid py-4">
      <div class="page-wrapper">
        <header class="page-header d-flex justify-content-between align-items-start">
          <div>
            <h1 class="page-title"><i class="fas fa-wrench me-2"></i>Mantenimientos</h1>
            <p class="page-sub">Registro y seguimiento de mantenimientos preventivos y correctivos, con responsables, fechas y adjuntos.</p>
          </div>
          <div>
            <a href="/reportes/mantenimientos.xlsx" class="btn btn-outline-success btn-compact me-2"><i class="fas fa-file-excel"></i> Exportar Excel</a>
            <button id="btnNuevo" data-server="true" class="btn btn-success btn-compact"><i class="fas fa-plus me-1"></i> Nuevo mantenimiento</button>
          </div>
        </header>

        <!-- Filtros en card -->
        <div class="card mb-3">
          <div class="card-body toolbar">
            <div class="row g-2 align-items-end">

              <div class="col-sm-6 col-lg-3">
                <label class="form-label">Descripción</label>
                <input id="q" class="form-control" placeholder="Buscar en descripción...">
              </div>

              <div class="col-sm-6 col-lg-3">
                <label class="form-label">Código inventario</label>
                <input id="fCodigo" class="form-control" placeholder="EQ-0001" list="dl_fcodigos">
                <datalist id="dl_fcodigos"></datalist>
              </div>

              <div class="col-sm-6 col-lg-2">
                <label class="form-label">Tipo</label>
                <select id="fTipo" class="form-select">
                  <option value="">Tipo...</option>
                </select>
              </div>

              <div class="col-sm-6 col-lg-2">
                <label class="form-label">Prioridad</label>
                <select id="fPri" class="form-select">
                  <option value="">Prioridad...</option>
                </select>
              </div>

              <div class="col-sm-6 col-lg-2">
                <label class="form-label">Resultado</label>
                <select id="fRes" class="form-select">
                  <option value="">Resultado...</option>
                </select>
              </div>

              <div class="col-sm-6 col-lg-3">
                <label class="form-label">Persona de mantenimiento</label>
                <input id="fPersona" class="form-control" placeholder="ID / Apellidos / Nombres" list="dl_personas_filter">
                <datalist id="dl_personas_filter"></datalist>
              </div>

              <!-- Botones Filtrar / Limpiar -->
              <div class="col-sm-6 col-lg-3 ms-auto d-flex justify-content-end gap-2 mt-2 mt-lg-0">
                <button id="btnLimpiar" class="btn btn-outline-secondary btn-filter">Limpiar</button>
                <button id="btnFiltrar" class="btn btn-dark btn-filter">Filtrar</button>
              </div>

            </div>
          </div>
        </div>

        <!-- Tabla en card -->
        <div class="card table-card">
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-bordered table-striped table-hover align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>#</th>
                    <th>Equipo</th>
                    <th>Tipo</th>
                    <th>Prioridad</th>
                    <th>Programada</th>
                    <th>Ejecución</th>
                    <th>Próx. venc.</th>
                    <th>Resultado</th>
                    <th>Responsable</th>
                    <th>Adjunto</th>
                    <th class="col-acciones">Acciones</th>
                  </tr>
                </thead>
                <tbody id="tbody">
                  <% mantenimientos.forEach(m => { %>
                    <tr>
                      <td><%= m.id %></td>
                      <td>
                        <%= m.Equipo
                              ? (m.Equipo.codigo_inventario || ('#'+m.equipoId))
                              : ('#'+m.equipoId) %>
                      </td>
                      <td><%= m.tipo %></td>
                      <td><%= m.prioridad %></td>
                      <td><%= m.fecha_programada || '' %></td>
                      <td><%= m.fecha_ejecucion || '' %></td>
                      <td><%= m.proximo_vencimiento || '' %></td>
                      <td><%= m.resultado || '' %></td>
                      <td>
                        <%= m.PersonaMantenimiento
                              ? (m.PersonaMantenimiento.identificacion + ' — ' +
                                 m.PersonaMantenimiento.apellidos + ', ' +
                                 m.PersonaMantenimiento.nombres)
                              : '' %>
                      </td>
                      <td>
                        <% if (m.adjunto_url) { %>
                          <% if (m.adjunto_url.endsWith('.pdf')) { %>
                            <a href="<%= m.adjunto_url %>" target="_blank" class="btn btn-sm btn-outline-dark">
                              PDF
                            </a>
                          <% } else { %>
                            <a href="<%= m.adjunto_url %>" target="_blank">
                              <img src="<%= m.adjunto_url %>" alt="Adjunto" class="preview-img">
                            </a>
                          <% } %>
                        <% } %>
                      </td>
                      <td class="col-acciones">
                        <button class="btn btn-sm btn-warning btn-compact me-1" data-act="edit" data-id="<%= m.id %>">
                          Editar
                        </button>
                        <button class="btn btn-sm btn-danger btn-compact" data-act="del" data-id="<%= m.id %>">
                          Eliminar
                        </button>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Modal Crear/Editar -->
        <div class="modal fade" id="modal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg">
            <form class="modal-content" id="form">
              <div class="modal-header">
                <h5 class="modal-title" id="title">Nuevo mantenimiento</h5>
                <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
              </div>

              <div class="modal-body">
                <input type="hidden" id="id">
                <div class="row g-3">

                  <div class="col-md-4">
                    <label class="form-label">Código inventario</label>
                    <input id="codigo_inventario" list="dl_codigos" class="form-control" placeholder="EQ-0001" required>
                    <datalist id="dl_codigos"></datalist>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Tipo</label>
                    <select id="tipo" class="form-select" required></select>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Prioridad</label>
                    <select id="prioridad" class="form-select" required></select>
                  </div>

                  <div class="col-md-3">
                    <label class="form-label">Resultado</label>
                    <select id="resultado" class="form-select">
                      <option value="">(pendiente)</option>
                    </select>
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Fecha programada</label>
                    <input id="fecha_programada" type="datetime-local" class="form-control">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Fecha ejecución</label>
                    <input id="fecha_ejecucion" type="datetime-local" class="form-control">
                  </div>

                  <div class="col-md-4">
                    <label class="form-label">Próx. vencimiento</label>
                    <input id="proximo_vencimiento" type="date" class="form-control">
                  </div>

                  <!-- Responsable -->
                  <div class="col-md-6">
                    <label class="form-label">Responsable (persona de mantenimiento)</label>
                    <input id="persona_autocomplete" class="form-control" placeholder="Buscar: identificación, apellidos o nombres" list="dl_personas_modal" required>
                    <datalist id="dl_personas_modal"></datalist>
                    <div class="form-text">Escribe y selecciona una persona existente.</div>
                  </div>

                  <!-- Subida de archivo -->
                  <div class="col-md-6">
                    <label class="form-label">Adjunto (PDF / JPG / PNG máx. 5MB)</label>
                    <input id="adjunto_file" type="file" class="form-control" accept=".pdf,image/png,image/jpeg">
                    <div class="form-text">Al subir el archivo se genera automáticamente el enlace.</div>
                  </div>

                  <div class="col-md-6">
                    <label class="form-label">Adjunto URL</label>
                    <input id="adjunto_url" class="form-control" placeholder="http(s)://..." readonly>
                    <a id="adjunto_preview" href="#" target="_blank" style="display:none">Ver adjunto</a>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Descripción</label>
                    <textarea id="descripcion" class="form-control" rows="3"></textarea>
                  </div>

                  <div class="col-12">
                    <label class="form-label">Observaciones</label>
                    <textarea id="observaciones" class="form-control" rows="3"></textarea>
                  </div>

                </div>
              </div>

              <div class="modal-footer">
                <button class="btn btn-secondary btn-compact" data-bs-dismiss="modal" type="button">Cancelar</button>
                <button class="btn btn-primary btn-compact" type="submit">Guardar</button>
              </div>
            </form>
          </div>
        </div>

        <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer"></div>

      </div><!-- /.page-wrapper -->
    </div><!-- /.container-fluid -->
  </main>

  <footer class="mt-auto text-center small">
    <div class="container">
      <p class="mb-0">© <%= new Date().getFullYear() %> USTA – Módulo de gestión de inventario y registro de mantenimientos</p>
    </div>
  </footer>

  <script>
    // inyecta rol inicialmente (usado por el cliente si es necesario)
    window.userRole = '<%= currentUser ? currentUser.role : "user" %>';
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/mantenimientos.js"></script>

  <script>
    // TEMA OSCURO/CLARO (persistente y basado en preferencia)
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;

    function getInitialTheme() {
      const saved = localStorage.getItem('theme');
      if (saved) return saved;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function setTheme(theme) {
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const icon = themeToggle?.querySelector('i');
      if (icon) icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      // asegurar visibilidad botón nuevo según rol inyectado (cliente)
      const btn = document.getElementById('btnNuevo');
      try {
        const role = window.userRole ? String(window.userRole).toLowerCase() : '';
        if (btn) btn.style.display = (role === 'admin' || role === 'administrativo') ? 'inline-flex' : (btn?.dataset.server === 'true' ? btn.style.display : 'none');
      } catch(e){}
    }

    setTheme(getInitialTheme());

    themeToggle?.addEventListener('click', () => {
      const current = html.getAttribute('data-theme') || 'light';
      setTheme(current === 'dark' ? 'light' : 'dark');
    });

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) setTheme(e.matches ? 'dark' : 'light');
    });
  </script>
</body>
</html>
