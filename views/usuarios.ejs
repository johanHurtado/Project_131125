<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Gestión de usuarios | Inventario & Mantenimientos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    * { transition: background-color 0.25s ease, color 0.25s ease, box-shadow 0.25s ease; }

    :root{ --primary:#0d6efd; --muted:#6c757d; --card-radius:12px; --glass-blur:10px; --light-bg:#f5f7fa; --light-card:#ffffff; --light-text:#212529; --light-muted:#6c757d; }
    html[data-theme="dark"] { --light-bg:#0f3460; --light-card:rgba(22,33,62,0.75); --light-text:#e6eef8; --light-muted:#9fb6d9; }

    body { min-height:100vh; color:var(--light-text); background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.06), transparent 8%), radial-gradient(circle at 90% 80%, rgba(255,255,255,0.04), transparent 12%), linear-gradient(135deg, var(--light-bg) 0%, #c3cfe2 100%); -webkit-font-smoothing:antialiased; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; font-size:0.95rem; }
    html[data-theme="dark"] body{ background: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02), transparent 8%), radial-gradient(circle at 90% 80%, rgba(255,255,255,0.01), transparent 12%), linear-gradient(135deg, #0f3460 0%, #16213e 100%); }

    .navbar{ background: linear-gradient(90deg, var(--light-card) 0%, rgba(255,255,255,0.95) 100%) !important; backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border:1px solid rgba(255,255,255,0.22); box-shadow:0 8px 30px rgba(7,12,31,0.06); }
    html[data-theme="dark"] .navbar{ background: linear-gradient(90deg, rgba(22,33,62,0.92), rgba(15,52,96,0.92)) !important; border:1px solid rgba(255,255,255,0.06); }

    .navbar-brand { font-weight:700; font-size:1.15rem; display:flex; gap:.6rem; align-items:center; }
    .navbar-brand img { height:36px; width:auto; }

    main { padding:2.25rem 0; }
    .page-wrapper { max-width:1200px; margin:0 auto; }

    .page-header { border-radius:16px; padding:1.6rem; margin-bottom:1.6rem; background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.75)); backdrop-filter: blur(var(--glass-blur)); border:1px solid rgba(255,255,255,0.2); box-shadow: 0 12px 36px rgba(7,12,31,0.06); }
    html[data-theme="dark"] .page-header{ background: linear-gradient(135deg, rgba(22,33,62,0.9), rgba(15,52,96,0.85)); border:1px solid rgba(255,255,255,0.06); }

    .page-title { font-weight:700; background:linear-gradient(135deg,var(--primary),#0dcaf0); background-clip: text; -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:0.25rem; font-size:1.05rem; }
    .page-sub { color:var(--light-muted); margin:0; font-size:0.9rem; }

    .table-card { border-radius: 14px; overflow:hidden; background: linear-gradient(135deg, rgba(255,255,255,0.85), rgba(255,255,255,0.7)); border:1px solid rgba(255,255,255,0.18); box-shadow: 0 18px 50px rgba(7,12,31,0.06); }
    html[data-theme="dark"] .table-card{ background: linear-gradient(135deg, rgba(22,33,62,0.72), rgba(15,52,96,0.65)); border:1px solid rgba(255,255,255,0.06); box-shadow:0 18px 50px rgba(0,0,0,0.35); }

    .table thead th{ background: linear-gradient(135deg, rgba(13,110,253,0.06), rgba(13,202,240,0.03)); border-bottom:2px solid rgba(13,110,253,0.12); color:var(--light-text); text-transform:uppercase; font-weight:600; font-size:0.78rem; }
    html[data-theme="dark"] .table thead th{ border-bottom:2px solid rgba(255,255,255,0.06); }

    .table tbody tr { transition:background 0.2s ease, transform 0.2s ease; }
    .table tbody tr:hover { background: linear-gradient(135deg, rgba(13,110,253,0.04), rgba(13,202,240,0.02)); transform:translateY(-2px); }

    .btn-compact { padding:0.45rem 0.75rem; font-size:0.85rem; border-radius:8px; font-weight:600; }
    .btn-success { background: linear-gradient(135deg,#198754 0%, #20c997 100%); color:white; border:none; }
    .btn-warning { background: linear-gradient(135deg,#ffc107,#ff9800); color:white; border:none; }
    .btn-danger { background: linear-gradient(135deg,#dc3545,#e74c3c); color:white; border:none; }

    .modal-content{ border-radius:14px; backdrop-filter: blur(var(--glass-blur)); background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95)); border:1px solid rgba(255,255,255,0.3); box-shadow:0 30px 80px rgba(7,12,31,0.12); }
    html[data-theme="dark"] .modal-content{ background: linear-gradient(135deg, rgba(22,33,62,0.95), rgba(15,52,96,0.95)); border:1px solid rgba(255,255,255,0.06); box-shadow:0 30px 80px rgba(0,0,0,0.45); }

    .form-control, .form-select { border-radius:8px; border:1px solid rgba(0,0,0,0.08); background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(255,255,255,0.9)); color:var(--light-text); }
    html[data-theme="dark"] .form-control, html[data-theme="dark"] .form-select { background: linear-gradient(135deg, rgba(22,33,62,0.85), rgba(15,52,96,0.8)); border:1px solid rgba(255,255,255,0.06); }

    .col-acciones { text-align:center; width:160px; white-space:nowrap; }
    .toast-stack { position: fixed; right: 1rem; bottom: 1rem; z-index: 1080; }

    @media (max-width:768px){ .page-header { padding:1rem; } .page-title { font-size:1rem; } .table thead th { font-size:0.7rem; } .btn-compact { padding:0.35rem 0.6rem; font-size:0.8rem; } }
  </style>
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="/">
        <img src="/img/logosanrafa.png" alt="HSRT logo" class="rounded">
        <span>HSRT</span>
      </a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNavbar">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="/equipos"><i class="fas fa-box me-1"></i>Equipos</a></li>
          <li class="nav-item"><a class="nav-link" href="/ubicaciones"><i class="fas fa-map-pin me-1"></i>Ubicaciones</a></li>
          <li class="nav-item"><a class="nav-link" href="/responsables-custodios"><i class="fas fa-user me-1"></i>Responsables</a></li>
          <li class="nav-item"><a class="nav-link" href="/personas-mantenimiento"><i class="fas fa-users me-1"></i>Personas</a></li>
          <li class="nav-item"><a class="nav-link" href="/cargos"><i class="fas fa-briefcase me-1"></i>Cargos</a></li>
          <li class="nav-item"><a class="nav-link" href="/mantenimientos"><i class="fas fa-wrench me-1"></i>Mantenimientos</a></li>
          <% if (currentUser && currentUser.role === 'admin') { %>
          <li class="nav-item">
            <a class="nav-link" href="/usuarios"><i class="fas fa-user-shield me-1"></i>Usuarios</a>
          </li>
          <% } %>
          <li class="nav-item"><a class="nav-link" href="/mi-perfil"><i class="fas fa-user-circle me-1"></i>Mi perfil</a></li>
        </ul>

        <div class="d-flex align-items-center gap-3">
          <button class="btn btn-theme" id="themeToggle" title="Cambiar tema" style="border-radius:50%; width:40px; height:40px; display:flex; align-items:center; justify-content:center;">
            <i class="fas fa-moon"></i>
          </button>

          <% if (currentUser) { %>
            <span class="navbar-text me-2 text-muted small">
              <i class="fas fa-user-check me-1"></i>
              <strong><%= currentUser.username %></strong> |
              <strong><%= currentUser.role %></strong>
            </span>
            <form method="post" action="/logout" class="d-inline m-0">
              <button class="btn btn-danger btn-compact"><i class="fas fa-sign-out-alt me-1"></i>Salir</button>
            </form>
          <% } %>
        </div>
      </div>
    </div>
  </nav>

  <!-- MAIN -->
  <main class="flex-grow-1">
    <div class="container-fluid py-4">
      <div class="page-wrapper">
        <header class="page-header d-flex justify-content-between align-items-start">
          <div>
            <h1 class="page-title"><i class="fas fa-user-shield me-2"></i>Gestión de usuarios</h1>
            <p class="page-sub">Administración de cuentas de acceso al módulo: creación, edición de roles y control básico.</p>
          </div>
          <div>
            <button class="btn btn-success btn-compact" id="btnNuevo"><i class="fas fa-plus me-1"></i> Nuevo usuario</button>
          </div>
        </header>

        <!-- Filtro de búsqueda -->
        <div class="card mb-3">
          <div class="card-body toolbar">
            <div class="row g-2 align-items-end">
              <div class="col-sm-8 col-md-6 col-lg-4">
                <label class="form-label">Buscar</label>
                <input type="text" class="form-control" id="search" placeholder="Usuario o rol...">
              </div>
              <div class="col-sm-4 col-md-3 col-lg-2 d-flex gap-2">
                <button id="btnLimpiarFiltro" class="btn btn-outline-secondary btn-compact w-100">Limpiar filtro</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Tabla de usuarios -->
        <div class="card table-card">
          <div class="table-responsive">
            <table class="table table-hover table-bordered align-middle mb-0" id="tablaUsuarios">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Usuario</th>
                  <th>Rol</th>
                  <th>Creado</th>
                  <th>Actualizado</th>
                  <th class="text-center" style="width:180px;">Acciones</th>
                </tr>
              </thead>
              <tbody id="tbodyUsuarios">
                <% usuarios.forEach(u => { %>
                  <tr data-id="<%= u.id %>">
                    <td><%= u.id %></td>
                    <td><%= u.username %></td>
                    <td>
                      <span class="badge bg-<%= u.role === 'admin' ? 'danger' : 'secondary' %>">
                        <%= u.role %>
                      </span>
                    </td>
                    <td>
                      <%= u.createdAt
                            ? new Date(u.createdAt).toLocaleString('es-CO',{ timeZone:'America/Bogota' })
                            : '' %>
                    </td>
                    <td>
                      <%= u.updatedAt
                            ? new Date(u.updatedAt).toLocaleString('es-CO',{ timeZone:'America/Bogota' })
                            : '' %>
                    </td>
                    <td class="text-center">
                      <button class="btn btn-sm btn-outline-primary btn-compact btn-edit">Editar</button>
                      <button class="btn btn-sm btn-outline-danger btn-compact btn-delete">Eliminar</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Modal crear/editar -->
        <div class="modal fade" id="modalUsuario" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog">
            <div class="modal-content">
              <form id="formUsuario">
                <div class="modal-header">
                  <h5 class="modal-title" id="modalTitulo">Nuevo usuario</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <input type="hidden" id="usuarioId">

                  <div class="mb-3">
                    <label class="form-label">Usuario</label>
                    <input type="text" class="form-control" id="username" required>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Contraseña</label>
                    <input type="password" class="form-control" id="password" placeholder="••••••">
                    <small class="text-muted" id="helpPassword">Para nuevo usuario es obligatoria. Al editar, deje en blanco si no desea cambiarla.</small>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Rol</label>
                    <select class="form-select" id="role" required>
                      <option value="user">user</option>
                      <option value="admin">admin</option>
                      <option value="administrativo">administrativo</option>
                    </select>
                  </div>

                  <div class="alert alert-danger d-none" id="errorBox"></div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary btn-compact" data-bs-dismiss="modal">Cancelar</button>
                  <button type="submit" class="btn btn-primary btn-compact" id="btnGuardar">Guardar</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Toast bootstrap básico -->
        <div class="toast-stack" id="toastContainer"></div>

      </div>
    </div>
  </main>

  <footer class="mt-auto text-center small">
    <div class="container">
      <p class="mb-0">© <%= new Date().getFullYear() %> USTA – Módulo de gestión de inventario y registro de mantenimientos</p>
    </div>
  </footer>

  <script>
    // inyecta rol inicialmente (usado por el cliente si es necesario)
    window.userRole = '<%= currentUser ? currentUser.role : "user" %>';
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/usuarios.js"></script>

  <script>
    // TEMA OSCURO/CLARO (persistente y basado en preferencia)
    const themeToggle = document.getElementById('themeToggle');
    const html = document.documentElement;

    function getInitialTheme() {
      const saved = localStorage.getItem('theme');
      if (saved) return saved;
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    }

    function setTheme(theme) {
      html.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      const icon = themeToggle?.querySelector('i');
      if (icon) icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      // asegurar visibilidad botón nuevo según rol inyectado (cliente)
      const btn = document.getElementById('btnNuevo');
      try {
        const role = window.userRole ? String(window.userRole).toLowerCase() : '';
        if (btn) btn.style.display = (role === 'admin' || role === 'administrativo') ? 'inline-flex' : (btn?.dataset.server === 'true' ? btn.style.display : 'none');
      } catch(e){}
    }

    setTheme(getInitialTheme());

    themeToggle?.addEventListener('click', () => {
      const current = html.getAttribute('data-theme') || 'light';
      setTheme(current === 'dark' ? 'light' : 'dark');
    });

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      if (!localStorage.getItem('theme')) setTheme(e.matches ? 'dark' : 'light');
    });
  </script>
</body>
</html>
